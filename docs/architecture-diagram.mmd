graph TD
    User[End Users]

    subgraph "Channels"
        direction TB
        WhatsApp[WhatsApp Cloud API]
        Twilio[Twilio SMS]
        AWSMessaging[AWS End User Messaging]
    end

    subgraph "Serverless Ingestion"
        APIGW[Amazon API Gateway]
        Handler[Universal Message Handler<br/>AWS Lambda]
    end

    subgraph "Intelligence Services"
        Agent[Bedrock Reasoning Agent]
        MealService[Meal Planning Service]
        NutritionService[Nutrition Insights Service]
        SubscriptionService[Subscription & Billing Service]
        Notifications[Notification Management]
        AnalyticsService[Analytics & Usage Tracking]
    end

    subgraph "Data Stores"
        Dynamo[(Amazon DynamoDB<br/>Users, Plans, Usage, Revenue, Cache)]
        ParameterStore[SSM Parameter Store]
    end

    subgraph "AI Platform"
        Bedrock[Amazon Bedrock Models]
    end

    subgraph "Messaging Providers"
        PlatformAdapter[Messaging Provider Adapter]
    end

    User -->|Conversations| WhatsApp
    User -->|SMS| Twilio
    User -->|SMS| AWSMessaging

    WhatsApp -->|Webhooks| APIGW
    Twilio -->|Webhooks| APIGW
    AWSMessaging -->|Events| APIGW

    APIGW --> Handler

    Handler --> Agent
    Agent --> Bedrock

    Handler --> MealService
    Handler --> NutritionService
    Handler --> SubscriptionService
    Handler --> Notifications
    Handler --> AnalyticsService

    MealService --> Dynamo
    NutritionService --> Dynamo
    SubscriptionService --> Dynamo
    AnalyticsService --> Dynamo

    Handler --> ParameterStore

    Handler --> PlatformAdapter
    PlatformAdapter --> WhatsApp
    PlatformAdapter --> Twilio
    PlatformAdapter --> AWSMessaging
    PlatformAdapter -->|Replies| User
